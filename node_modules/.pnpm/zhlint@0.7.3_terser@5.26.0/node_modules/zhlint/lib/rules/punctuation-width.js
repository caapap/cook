"use strict";
/**
 * @fileoverview
 *
 * This rule will format each punctuation into the right width options.
 *
 * Options:
 * - halfwidthPunctuation: string = `()[]{}`
 * - fullwidthPunctuation: string = `，。：；？！“”‘’`
 * - adjustedFullwidthPunctuation: string = `“”‘’`
 *
 * Details:
 * - skip half-width punctuations between half-width content without space
 * - skip successive multiple half-width punctuations
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.defaultConfig = void 0;
const parser_1 = require("../parser");
const messages_1 = require("./messages");
const util_1 = require("./util");
const widthPairList = [
    [`,`, `，`],
    [`.`, `。`],
    [`;`, `；`],
    [`:`, `：`],
    [`?`, `？`],
    [`!`, `！`],
    [`(`, `（`],
    [`)`, `）`],
    [`[`, `［`],
    [`]`, `］`],
    [`{`, `｛`],
    [`}`, `｝`]
];
const widthSidePairList = [
    [`"`, `“`, `”`],
    [`'`, `‘`, `’`]
];
const defaultHalfwidthOption = `()[]{}`;
const defaultFullwidthOption = `，。：；？！“”‘’`;
const defaultAdjustedFullwidthOption = `“”‘’`;
const checkAdjusted = (token, adjusted) => {
    if (adjusted.indexOf(token.modifiedValue) >= 0) {
        token.modifiedType = (0, parser_1.getHalfwidthTokenType)(token.type);
    }
};
const parseOptions = (options) => {
    const halfwidthOption = (options === null || options === void 0 ? void 0 : options.halfwidthPunctuation) || '';
    const fullwidthOption = (options === null || options === void 0 ? void 0 : options.fullwidthPunctuation) || '';
    const adjustedFullwidthOption = (options === null || options === void 0 ? void 0 : options.adjustedFullwidthPunctuation) || '';
    const halfwidthMap = {};
    const fullwidthMap = {};
    const fullwidthPairMap = {};
    widthPairList.forEach(([halfwidth, fullwidth]) => {
        if (halfwidthOption.indexOf(halfwidth) >= 0) {
            halfwidthMap[fullwidth] = halfwidth;
        }
        if (fullwidthOption.indexOf(fullwidth) >= 0) {
            fullwidthMap[halfwidth] = fullwidth;
        }
    });
    widthSidePairList.forEach(([half, left, right]) => {
        if (halfwidthOption.indexOf(half) >= 0) {
            halfwidthMap[left] = half;
            halfwidthMap[right] = half;
        }
        if (fullwidthOption.indexOf(left) >= 0 ||
            fullwidthOption.indexOf(right) >= 0) {
            fullwidthPairMap[half] = [left, right];
        }
    });
    return {
        halfwidthMap,
        fullwidthMap,
        fullwidthPairMap,
        adjusted: adjustedFullwidthOption
    };
};
const generateHandler = (options) => {
    const { halfwidthMap, fullwidthMap, fullwidthPairMap, adjusted } = parseOptions(options);
    const handleHyperSpaceOption = (token, _, group) => {
        // skip non-punctuation/quotation/bracket situations
        if (!(0, parser_1.isSinglePunctuationType)(token.type) &&
            token.type !== parser_1.HyperTokenType.BRACKET_MARK &&
            token.type !== parser_1.GroupTokenType.GROUP) {
            return;
        }
        // skip halfwidth punctuations between halfwidth content without space
        if ((0, util_1.isHalfwidthPunctuationWithoutSpaceAround)(group, token)) {
            return;
        }
        // skip successive multiple half-width punctuations
        if ((0, util_1.isSuccessiveHalfwidthPunctuation)(group, token)) {
            return;
        }
        // 1. normal punctuations in the alter width map
        // 2. brackets in the alter width map
        if ((0, parser_1.isSinglePunctuationType)(token.type) ||
            token.type === parser_1.HyperTokenType.BRACKET_MARK) {
            const value = token.modifiedValue;
            if (fullwidthMap[value]) {
                (0, util_1.checkValue)(token, fullwidthMap[value], (0, parser_1.getFullwidthTokenType)(token.type), messages_1.PUNCTUATION_FULL_WIDTH);
                checkAdjusted(token, adjusted);
            }
            else if (halfwidthMap[value]) {
                (0, util_1.checkValue)(token, halfwidthMap[value], (0, parser_1.getHalfwidthTokenType)(token.type), messages_1.PUNCTUATION_HALF_WIDTH);
            }
            return;
        }
        // 3. quotations in the alter pair map
        const startValue = token.modifiedStartValue;
        const endValue = token.modifiedEndValue;
        if (fullwidthPairMap[startValue]) {
            (0, util_1.checkStartValue)(token, fullwidthPairMap[startValue][0], messages_1.PUNCTUATION_FULL_WIDTH);
        }
        else if (halfwidthMap[startValue]) {
            (0, util_1.checkStartValue)(token, halfwidthMap[startValue][0], messages_1.PUNCTUATION_HALF_WIDTH);
        }
        if (fullwidthPairMap[endValue]) {
            (0, util_1.checkEndValue)(token, fullwidthPairMap[endValue][1], messages_1.PUNCTUATION_FULL_WIDTH);
        }
        else if (halfwidthMap[endValue]) {
            (0, util_1.checkEndValue)(token, halfwidthMap[endValue][1], messages_1.PUNCTUATION_HALF_WIDTH);
        }
    };
    return handleHyperSpaceOption;
};
exports.defaultConfig = {
    halfwidthPunctuation: defaultHalfwidthOption,
    fullwidthPunctuation: defaultFullwidthOption,
    adjustedFullwidthPunctuation: defaultAdjustedFullwidthOption
};
exports.default = generateHandler;
